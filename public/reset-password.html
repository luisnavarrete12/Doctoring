<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - Clínica San José</title>
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <h1>Nueva Contraseña</h1>
            <p>Crea una contraseña segura</p>
        </div>

        <div class="auth-form">
            <div id="alert" class="alert"></div>

            <div class="form-group">
                <label for="password">Nueva Contraseña</label>
                <input 
                    type="password" 
                    id="password" 
                    placeholder="Mínimo 6 caracteres"
                >
                <div class="password-strength">
                    <div class="password-strength-bar" id="strength-bar"></div>
                </div>
                <span class="error-message" id="password-error"></span>
            </div>

            <div class="form-group">
                <label for="confirm-password">Confirmar Contraseña</label>
                <input 
                    type="password" 
                    id="confirm-password" 
                    placeholder="Repite tu contraseña"
                >
                <span class="error-message" id="confirm-error"></span>
            </div>

            <button class="btn-primary" id="reset-btn" onclick="handleResetPassword()">
                Restablecer Contraseña
            </button>

            <div class="auth-links">
                <p><a href="login.html">← Volver al login</a></p>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // Indicador de fortaleza
        document.getElementById('password').addEventListener('input', (e) => {
            const password = e.target.value;
            const strengthBar = document.getElementById('strength-bar');
            
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            
            strengthBar.className = 'password-strength-bar';
            if (strength <= 1) strengthBar.classList.add('weak');
            else if (strength <= 2) strengthBar.classList.add('medium');
            else strengthBar.classList.add('strong');
        });
        
        // Obtener token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
            showAlert('Token no válido', 'error');
        }
        
        // Función para resetear
        async function handleResetPassword() {
            try {
                clearFieldErrors();
                
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!password || password.length < 6) {
                    showFieldError('password', 'La contraseña debe tener al menos 6 caracteres');
                    return;
                }
                
                if (!/\d/.test(password)) {
                    showFieldError('password', 'Debe contener al menos un número');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showFieldError('confirm-password', 'Las contraseñas no coinciden');
                    return;
                }
                
                const btn = document.getElementById('reset-btn');
                btn.classList.add('loading');
                btn.disabled = true;
                
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token, password })
                });
                
                const data = await response.json();
                
                btn.classList.remove('loading');
                btn.disabled = false;
                
                if (data.success) {
                    showAlert('¡Contraseña actualizada! Redirigiendo al login...', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showAlert(data.message || 'Error al restablecer contraseña', 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }
    </script>
</body>
</html>
```

---

## ✅ AHORA SÍ, TODO ESTÁ COMPLETO

### **Archivos que debes tener:**
```
✅ .env (con JWT_SECRET y EMAIL_*)
✅ database/db.js
✅ middleware/auth.js
✅ middleware/roleCheck.js
✅ utils/emailService.js
✅ routes/auth.routes.js
✅ routes/pacientes.routes.js (actualizado)
✅ server.js (actualizado)
✅ public/login.html
✅ public/register.html
✅ public/forgot-password.html
✅ public/reset-password.html
✅ public/index.html (actualizado con logout)
✅ public/css/auth.css
✅ public/css/styles.css
✅ public/js/auth.js
✅ public/js/app.js (actualizado con fetchWithAuth)